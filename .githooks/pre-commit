#!/bin/bash
# =============================================================================
# Git Pre-commit Hook - PAISS Static Site Quality Gate
# =============================================================================
# This runs automatically before every git commit to ensure code quality.
# Install: git config core.hooksPath .githooks

set -e

echo "üîç Running pre-commit quality checks..."

# Check if there are any changes staged for commit
if ! git diff --cached --quiet; then
    echo "üìã Changes detected, running validation..."

    # =========================================================================
    # PREVENT COMMITTING SECRETS
    # =========================================================================
    echo "üîí Checking for accidentally staged secrets..."

    # Check for .env files (but allow .env.production and .env.staging)
    if git diff --cached --name-only | grep -E '^\.env$|^\.env\.local$|^\.env\.development$' >/dev/null; then
        echo "‚ùå You are trying to commit .env files with potential secrets!"
        echo "   (.env, .env.local, .env.development)"
        echo ""
        echo "üîß To fix:"
        echo "   git reset HEAD .env .env.local .env.development"
        echo ""
        echo "üí° Note: .env.production and .env.staging are allowed (deployment configs)"
        exit 1
    fi

    # Check for other common secret files
    if git diff --cached --name-only | grep -qE '\.(pem|key)$'; then
        echo "‚ùå You are trying to commit certificate/key files!"
        echo "   These should never be committed."
        echo ""
        echo "üîß To fix:"
        echo "   git reset HEAD *.pem *.key"
        exit 1
    fi

    echo "‚úÖ No secrets detected"

    # =========================================================================
    # HTML VALIDATION (BASIC)
    # =========================================================================
    if git diff --cached --name-only | grep -qE '\.html$'; then
        echo "üîç Validating HTML files..."

        # Check if index.html exists and is not empty
        if [ -f "index.html" ]; then
            if [ ! -s "index.html" ]; then
                echo "‚ùå index.html is empty!"
                exit 1
            fi

            # Basic sanity checks
            if ! grep -q "<html" index.html; then
                echo "‚ö†Ô∏è  Warning: index.html doesn't appear to contain valid HTML structure"
            fi

            if ! grep -q "</html>" index.html; then
                echo "‚ö†Ô∏è  Warning: index.html doesn't appear to be properly closed"
            fi
        fi

        echo "‚úÖ HTML validation passed"
    fi

    # =========================================================================
    # CSS VALIDATION (BASIC)
    # =========================================================================
    if git diff --cached --name-only | grep -qE '\.css$'; then
        echo "üé® Checking CSS files..."

        # Check if styles.css exists and is not empty
        if [ -f "styles.css" ]; then
            if [ ! -s "styles.css" ]; then
                echo "‚ùå styles.css is empty!"
                exit 1
            fi
        fi

        echo "‚úÖ CSS validation passed"
    fi

else
    echo "üìã No changes staged for commit"
fi

echo "‚úÖ All quality checks passed - commit proceeding"
